package co.kr.imok.headream.app.ui

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Forward10
import androidx.compose.material.icons.filled.Pause
import androidx.compose.material.icons.filled.PlayArrow
import androidx.compose.material.icons.filled.Replay10
import androidx.compose.material.icons.filled.Stop
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import co.kr.imok.headream.app.audio.AudioPlaybackManager
import co.kr.imok.headream.app.data.CallRecord
import kotlinx.datetime.Instant
import kotlinx.datetime.TimeZone
import kotlinx.datetime.toLocalDateTime

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun CallDetailScreen(
    callRecord: CallRecord?,
    callIndex: Int = 1, // Î™á Î≤àÏß∏ ÏÉÅÎã¥ÌÜµÌôîÏù∏ÏßÄ
    isAudioPlaying: Boolean = false, // Ïô∏Î∂ÄÏóêÏÑú Í¥ÄÎ¶¨ÎêòÎäî Ïû¨ÏÉù ÏÉÅÌÉú
    onNavigateBack: () -> Unit,
    onPlayAudio: (String) -> Unit = {}, // Ïò§ÎîîÏò§ Ïû¨ÏÉù ÏΩúÎ∞±
    onLoadDetail: (String, (CallRecord?) -> Unit) -> Unit = { _, _ -> }, // ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏΩúÎ∞±
    modifier: Modifier = Modifier
) {
    var detailRecord by remember { mutableStateOf(callRecord) }
    
    // ÌôîÎ©¥ ÏßÑÏûÖ Ïãú ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    LaunchedEffect(callRecord?.id) {
        callRecord?.id?.let { callId ->
            println("üìã ÌÜµÌôî ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë: $callId")
            onLoadDetail(callId) { loadedRecord ->
                println("üìã ÌÜµÌôî ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å: ${loadedRecord != null}")
                detailRecord = loadedRecord ?: callRecord
            }
        }
    }
    
    Scaffold(
        topBar = {
            TopAppBar(
                title = { 
                    Text(
                        "${callIndex}Î≤àÏß∏ ÏÉÅÎã¥ÌÜµÌôî",
                        fontWeight = FontWeight.Medium
                    )
                },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(
                            imageVector = Icons.Default.ArrowBack,
                            contentDescription = "Îí§Î°úÍ∞ÄÍ∏∞"
                        )
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Color.White
                )
            )
        }
    ) { paddingValues ->
        if (detailRecord == null) {
            Box(
                modifier = modifier
                    .fillMaxSize()
                    .padding(paddingValues),
                contentAlignment = Alignment.Center
            ) {
                Text("ÌÜµÌôî Í∏∞Î°ùÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.")
            }
            return@Scaffold
        }
        
        Column(
            modifier = modifier
                .fillMaxSize()
                .padding(paddingValues)
                .verticalScroll(rememberScrollState())
        ) {
            detailRecord?.let { currentRecord ->
                // ÌÜµÌôî Ï†ïÎ≥¥ Ïπ¥Îìú
                CallInfoCard(callRecord = currentRecord)
                
                HorizontalDivider(color = Color(0xFFE0E0E0), thickness = 1.dp)
                
                // ÌÜµÌôî ÏöîÏïΩ Ïπ¥Îìú (ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
                currentRecord.summary?.let { summary ->
                    if (summary.isNotEmpty()) {
                        CallSummaryCard(summary = summary)
                        HorizontalDivider(color = Color(0xFFE0E0E0), thickness = 1.dp)
                    }
                }
                
                // ÌÜµÌôî Ï†ÑÏ≤¥ ÎÇ¥Ïö© Ïπ¥Îìú (ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
                val fullContent = currentRecord.callContent ?: currentRecord.transcription

                if (!fullContent.isNullOrEmpty()) {
                    CallContentCard(content = fullContent)
                    HorizontalDivider(color = Color(0xFFE0E0E0), thickness = 1.dp)
                } else {
                    println("‚ö†Ô∏è ÌÜµÌôî Ï†ÑÏ≤¥ ÎÇ¥Ïö©Ïù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§")
                }
                
                // ÏÉÅÎã¥ ÎÖπÏùå Îì£Í∏∞ Î≤ÑÌäº
                AudioPlayButton(
                    audioFilePath = currentRecord.audioFileUrl,
                    isPlaying = isAudioPlaying,
                    onPlayClick = { path ->
                        println("üéµ Ïò§ÎîîÏò§ Ïû¨ÏÉù Î≤ÑÌäº ÌÅ¥Î¶≠: $path")
                        onPlayAudio(path)
                    }
                )
            }
        }
    }
}

@Composable
private fun CallInfoCard(callRecord: CallRecord) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp),
        shape = RoundedCornerShape(0.dp) // Î™®ÏÑúÎ¶¨ Ï†úÍ±∞
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            // ÌÜµÌôî ÏãúÍ∞Ñ Î≤îÏúÑ
            val startTime = formatDateTime(callRecord.timestamp)
            val endTime = if (callRecord.duration > 0) {
                val endInstant = callRecord.timestamp.plus(kotlin.time.Duration.parse("${callRecord.duration}s"))
                formatDateTime(endInstant)
            } else {
                "Ï¢ÖÎ£åÏãúÍ∞Ñ ÎØ∏ÏÉÅ"
            }
            
            Text(
                text = "$startTime ~ $endTime",
                fontSize = 16.sp,
                fontWeight = FontWeight.Medium,
                color = Color(0xFF212121)
            )
            
            // ÏÉÅÎã¥ ÏãúÍ∞Ñ
            val durationText = formatDuration(callRecord.duration)
            Text(
                text = "ÏÉÅÎã¥ÏãúÍ∞Ñ : $durationText",
                fontSize = 14.sp,
                color = Color(0xFF666666)
            )
        }
    }
}

@Composable
private fun CallSummaryCard(summary: String) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp),
        shape = RoundedCornerShape(0.dp) // Î™®ÏÑúÎ¶¨ Ï†úÍ±∞
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Text(
                text = "ÌÜµÌôîÏöîÏïΩ",
                fontSize = 16.sp,
                fontWeight = FontWeight.Bold,
                color = Color(0xFF212121)
            )
            
            Text(
                text = summary,
                fontSize = 14.sp,
                lineHeight = 20.sp,
                color = Color(0xFF424242)
            )
        }
    }
}

@Composable
private fun CallContentCard(content: String) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp),
        shape = RoundedCornerShape(0.dp) // Î™®ÏÑúÎ¶¨ Ï†úÍ±∞
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Text(
                text = "ÌÜµÌôîÏ†ÑÏ≤¥ ÎÇ¥Ïö©",
                fontSize = 16.sp,
                fontWeight = FontWeight.Bold,
                color = Color(0xFF212121)
            )
            
            Text(
                text = content,
                fontSize = 14.sp,
                lineHeight = 20.sp,
                color = Color(0xFF424242)
            )
        }
    }
}

@Composable
private fun AudioPlayButton(
    audioFilePath: String?,
    isPlaying: Boolean,
    onPlayClick: (String) -> Unit
) {
    val isEnabled = !audioFilePath.isNullOrEmpty()
    
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp),
        shape = RoundedCornerShape(0.dp) // Î™®ÏÑúÎ¶¨ Ï†úÍ±∞
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            // Ïû¨ÏÉù Î≤ÑÌäº
            Button(
                onClick = { 
                    if (isEnabled) {
                        onPlayClick(audioFilePath!!)
                    }
                },
                enabled = isEnabled,
                modifier = Modifier
                    .fillMaxWidth()
                    .height(56.dp),
                colors = ButtonDefaults.buttonColors(
                    containerColor = if (isPlaying) Color(0xFFFF6B6B) else Color(0xFF4CAF50),
                    contentColor = Color.White,
                    disabledContainerColor = Color(0xFFE0E0E0),
                    disabledContentColor = Color(0xFF9E9E9E)
                ),
                shape = RoundedCornerShape(28.dp)
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Icon(
                        imageVector = if (isPlaying) Icons.Default.Pause else Icons.Default.PlayArrow,
                        contentDescription = if (isPlaying) "ÏùºÏãúÏ†ïÏßÄ" else "Ïû¨ÏÉù",
                        modifier = Modifier.size(24.dp)
                    )
                    
                    Text(
                        text = if (isPlaying) "Ïû¨ÏÉù Ï§ë..." else "ÏÉÅÎã¥ ÎÖπÏùå Îì£Í∏∞",
                        fontSize = 16.sp,
                        fontWeight = FontWeight.Medium
                    )
                }
            }
            
            // Ïû¨ÏÉù Ïª®Ìä∏Î°§Î∞î (Ïû¨ÏÉù Ï§ëÏùº ÎïåÎßå ÌëúÏãú)
            if (isPlaying) {
                Spacer(modifier = Modifier.height(16.dp))
                AudioControlBar(
                    onStopClick = {
                        audioFilePath?.let { path ->
                            onPlayClick(path) // Ïû¨ÏÉù ÏÉÅÌÉúÎ•º ÌÜ†Í∏ÄÌï¥ÏÑú Ï†ïÏßÄ
                        }
                    }
                )
            }
        }
    }
}

@Composable
private fun AudioControlBar(
    onStopClick: () -> Unit = {}
) {
    // Ïã§Ï†ú Ïò§ÎîîÏò§ Ïû¨ÏÉù ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞
    var currentPosition by remember { mutableStateOf(0L) }
    var totalDuration by remember { mutableStateOf(0L) }
    var isCurrentlyPlaying by remember { mutableStateOf(false) }
    
    // Ïû¨ÏÉù ÏãúÍ∞Ñ Î∞è ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    LaunchedEffect(Unit) {
        while (true) {
            try {
                currentPosition = AudioPlaybackManager.getCurrentPosition()
                val duration = AudioPlaybackManager.getDuration()
                if (duration > 0) {
                    totalDuration = duration
                }
                isCurrentlyPlaying = AudioPlaybackManager.isPlaying()
                kotlinx.coroutines.delay(1000)
            } catch (e: Exception) {
                println("‚ö†Ô∏è Ïò§ÎîîÏò§ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${e.message}")
                kotlinx.coroutines.delay(1000)
            }
        }
    }
    
    Column {
        // ÏßÑÌñâ Î∞î
        Row(
            modifier = Modifier.fillMaxWidth(),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = formatTime((currentPosition / 1000).toInt()),
                fontSize = 12.sp,
                color = Color.Gray,
                modifier = Modifier.width(40.dp)
            )
            
            Slider(
                value = if (totalDuration > 0) currentPosition.toFloat() else 0f,
                onValueChange = { newPosition ->
                    try {
                        AudioPlaybackManager.seekTo(newPosition.toLong())
                        println("üéØ Slider ÏúÑÏπò Î≥ÄÍ≤Ω: ${newPosition.toLong()}ms")
                    } catch (e: Exception) {
                        println("‚ùå Slider ÏúÑÏπò Î≥ÄÍ≤Ω Ïã§Ìå®: ${e.message}")
                    }
                },
                valueRange = 0f..(if (totalDuration > 0) totalDuration.toFloat() else 1f),
                modifier = Modifier.weight(1f),
                colors = SliderDefaults.colors(
                    thumbColor = Color(0xFF4CAF50),
                    activeTrackColor = Color(0xFF4CAF50),
                    inactiveTrackColor = Color(0xFFE0E0E0)
                )
            )
            
            Text(
                text = formatTime((totalDuration / 1000).toInt()),
                fontSize = 12.sp,
                color = Color.Gray,
                modifier = Modifier.width(40.dp)
            )
        }
        
        Spacer(modifier = Modifier.height(8.dp))
        
        // Ïª®Ìä∏Î°§ Î≤ÑÌäºÎì§
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.Center,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // ÎêòÍ∞êÍ∏∞ Î≤ÑÌäº
            IconButton(
                onClick = { 
                    try {
                        val newPosition = maxOf(0L, currentPosition - 15000L) // 15Ï¥à = 15000ms
                        AudioPlaybackManager.seekTo(newPosition)
                        println("‚è™ 15Ï¥à ÎêòÍ∞êÍ∏∞: ${newPosition}ms")
                    } catch (e: Exception) {
                        println("‚ùå ÎêòÍ∞êÍ∏∞ Ïã§Ìå®: ${e.message}")
                    }
                }
            ) {
                Icon(
                    imageVector = Icons.Default.Replay10,
                    contentDescription = "15Ï¥à ÎêòÍ∞êÍ∏∞",
                    tint = Color(0xFF4CAF50)
                )
            }
            
            Spacer(modifier = Modifier.width(16.dp))
            
            // ÏùºÏãúÏ†ïÏßÄ/Ïû¨ÏÉù Î≤ÑÌäº
            IconButton(
                onClick = { 
                    try {
                        if (isCurrentlyPlaying) {
                            AudioPlaybackManager.pause()
                            println("‚è∏Ô∏è Ïû¨ÏÉù ÏùºÏãúÏ†ïÏßÄ")
                        } else {
                            AudioPlaybackManager.resume()
                            println("‚ñ∂Ô∏è Ïû¨ÏÉù Ïû¨Í∞ú")
                        }
                    } catch (e: Exception) {
                        println("‚ùå ÏùºÏãúÏ†ïÏßÄ/Ïû¨ÏÉù Ïã§Ìå®: ${e.message}")
                    }
                }
            ) {
                Icon(
                    imageVector = if (isCurrentlyPlaying) Icons.Default.Pause else Icons.Default.PlayArrow,
                    contentDescription = if (isCurrentlyPlaying) "ÏùºÏãúÏ†ïÏßÄ" else "Ïû¨ÏÉù",
                    tint = Color(0xFF4CAF50)
                )
            }
            
            Spacer(modifier = Modifier.width(16.dp))
            
            // Îπ®Î¶¨Í∞êÍ∏∞ Î≤ÑÌäº
            IconButton(
                onClick = { 
                    try {
                        val newPosition = if (totalDuration > 0) {
                            minOf(totalDuration, currentPosition + 15000L) // 15Ï¥à = 15000ms
                        } else {
                            currentPosition + 15000L
                        }
                        AudioPlaybackManager.seekTo(newPosition)
                        println("‚è© 15Ï¥à Îπ®Î¶¨Í∞êÍ∏∞: ${newPosition}ms")
                    } catch (e: Exception) {
                        println("‚ùå Îπ®Î¶¨Í∞êÍ∏∞ Ïã§Ìå®: ${e.message}")
                    }
                }
            ) {
                Icon(
                    imageVector = Icons.Default.Forward10,
                    contentDescription = "15Ï¥à Îπ®Î¶¨Í∞êÍ∏∞",
                    tint = Color(0xFF4CAF50)
                )
            }
        }
    }
}

private fun formatTime(seconds: Int): String {
    val minutes = seconds / 60
    val remainingSeconds = seconds % 60
    return "${minutes}:${remainingSeconds.toString().padStart(2, '0')}"
}

private fun formatDateTime(instant: Instant): String {
    val dateTime = instant.toLocalDateTime(TimeZone.currentSystemDefault())
    val year = dateTime.year
    val month = dateTime.monthNumber
    val day = dateTime.dayOfMonth
    val hour = dateTime.hour
    val minute = dateTime.minute
    val second = dateTime.second
    
    return "${year}ÎÖÑ ${month}Ïõî ${day}Ïùº ${hour.toString().padStart(2, '0')}Ïãú ${minute.toString().padStart(2, '0')}Î∂Ñ ${second.toString().padStart(2, '0')}Ï¥à"
}

private fun formatDuration(seconds: Long): String {
    return if (seconds >= 60) {
        val minutes = seconds / 60
        val remainingSeconds = seconds % 60
        "${minutes}Î∂Ñ ${remainingSeconds}Ï¥à"
    } else {
        "${seconds}Ï¥à"
    }
}
